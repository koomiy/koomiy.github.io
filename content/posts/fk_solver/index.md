---
title: "005 - 人型ロボットの順運動学"
date: 2023-07-06
categories: ["vnoidベースの開発"]
menu: main
---

---

## 今回の内容

本チャレンジでは、初心者の方でも簡単に人形ロボットの運動計画ができるように、  
vnoidというサンプルパッケージが用意されております。

今回はvnoidパッケージの機能の一つ、  
順運動学ソルバーについて解説します。

---

## 順運動学とは
順運動学とは、ロボットにある関節変位(回転・並進どちらでも可)を与えたときの  
先端効果器の位置・姿勢を求める問題のことです。

人型ロボットの腰リンク(以降ベースリンクと呼びます)の中心に基準座標 $\Sigma_0$ を置きます。  
基準座標系$\Sigma_0$から見た各リンク座標系 $\Sigma_i$ の位置・姿勢を計算し、  
最終的に先端効果器の位置・姿勢を求めるのが目標です。

(画像: 基準座標系からリンクiの座標系の位置・姿勢を求めようとしていることが分かる図)

目標達成のため、ある座標系 $\Sigma_a$ から別の座標系 $\Sigma_b$ を定義する  
一般的な方法について考えてみましょう。

$\Sigma_a$に対する$\Sigma_b$の位置に関しては、  
並進方向の位置の差$\boldsymbol{{}^ap_b}$によって表現できます。

次に、$\Sigma_a$に対する$\Sigma_b$の姿勢の表現方法について考えてみましょう。  
そのために、$\Sigma_b$ から見て常に同じ場所に位置する点$E$について考えてみます。  
つまり、$\boldsymbol{{}^bp_E}$は固定ベクトルです。

$\Sigma_a$ から見た点$E$ $\boldsymbol{{}^ap_E}$ は、  
$\Sigma_b$ の回転に伴って位置が変わったように見えます。  
よって、$\boldsymbol{{}^ap_E}$ を、$\Sigma_a$から見た$\Sigma_b$の回転で表現できれば、  
$\Sigma_a$に対する$\Sigma_b$の姿勢をうまく表現できていることになります。

$\Sigma_a$ の各軸周りに $\Sigma_b$ がどれだけ回転しているかを考えます。  
一般にロール・ピッチ・ヨー方向に回転しているとして、  
各軸周りの回転を、回転行列 $\boldsymbol{{}^aR_b}$ で定義します。  
回転行列をかければベクトルは指定したロール・ピッチ・ヨー回転をしますので、  
以下図のような構図が見えてきます。  
(画像: 座標系と点Eの構図が分かる図)
よって、$\boldsymbol{{}^ap_E}$を次の式で与えられます。  
$$ \boldsymbol{{}^ap_E} = \boldsymbol{{}^ap_b} + \boldsymbol{{}^aR_b} \boldsymbol{{}^bp_E} $$  

以上のことから、$\Sigma_a$から見た$\Sigma_b$の位置・姿勢は、  
$\boldsymbol{{}^ap_b}$と$\boldsymbol{{}^aR_b}$によって表現できることが分かります。  
(同次変換行列によって簡潔に座標変換式を与えられる)

ロボットの関節変位は $q_i$ で表され、  
デフォルトのvnoidでは、回転変位のみ扱えます。

関節変位をリストで並べた関節変位ベクトルを、  
$\boldsymbol{q} = [q_1, q_2, ..., q_n]^T$ により定義します。

---

## vnoidロボットの機構モデル

サンプルコードの解説に入る前に、vnoidロボットの機構モデルについて説明します。  
以下図に示すのが、vnoidロボットの機構モデルです。  
{{<figure src="./biped_robot_model.png" class="center" alt="vnoidロボットの機構モデル" width="50%">}}

vnoidのロボットには、1本の腕につき7つ、1本の脚につき6つの関節がついています。  
ロボットの関節にはそれぞれが識別できるように以下図のようにidが振られています。  
なお、ロボットから見て右側の機構については省略しています。  
{{<figure src="./biped_arm_model.png" class="center" alt="腕の機構モデル" width="50%">}}  
{{<figure src="./biped_leg_model.png" class="center" alt="脚の機構モデル" width="35%">}}


図中の$r$, $p$, $y$ はそれぞれロール・ピッチ・ヨーを表しており、  
その刻印が入った関節モーターは、その方向に回転します。  
なお、ロール・ピッチ・ヨー方向の回転はそれぞれ、  
$x$, $y$, $z$軸周りの回転に対応します。

---

## サンプルコードの解説

'vnoid/src/fksolver.cpp'を、脚の順運動学計算を例に解説します。  
脚の順運動学計算は、FkSolver::Comp関数内の124行目から始まります。

まず変数の定義についてです。
```cpp
leg_pos
```
、
```cpp
leg_ori
```
、
```cpp
leg_axis
```
はそれぞれ、  
ベースリンク座標を基準としたときの、  
脚関節のローカル座標の位置、回転姿勢、回転軸ベクトルです。  
なお回転姿勢については四元数で定義されます。

上から順に解説します。  
まず、125~128行目についてです。

```cpp
for(int i = 0; i < 2; i++){
	for(int j = 0; j < 6; j++){
		q[j] = joint[param.leg_joint_index[i] + j].q;
	}
	...
```

最初のfor文は、左右脚のうち一本ずつ順運動学計算をすることを意味します。  
その一つ下の階層のfor文で、脚関節の回転変位を一つずつ一般変位$q[7]$に代入します。







---

## 例題

趣向を凝らして、とあるインド映画のワンショットを再現してみましょう。
(鋭意製作中...)

---

## まとめ・次回予告

今回はvnoidパッケージの順運動学ソルバーについて解説しました。

次回：歩行ステップ計画
